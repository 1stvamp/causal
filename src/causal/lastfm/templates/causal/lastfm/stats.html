{% extends "causal/base.html" %}
{% load media_loaders %}
{% block primary %}
    {% load_js "OpenLayers/OpenLayers-2.10.min.js" %}
    {% load_css "OpenLayers/theme/default/style.css" %}
    {% load_js "//ecn.dev.virtualearth.net/mapcontrol/mapcontrol.ashx?v=6.2" %}
{% if favourite_artists %}
    <h1> Most played artists for the last 7 days</h1>
    <ul>
    {% for artist in favourite_artists %}
        <li>{{ forloop.counter }}. {{artist.name }}</li>
    {% endfor %}
    </ul>

    <ul>
    {% for artist in favourite_artists %}
        {% if artist.gigs %}
            <li>
            <h2>{{artist.name}}</h2>
            {% for gig in artist.gigs %}
                <ul>
                    <li>{{gig.date}} at <a href="{{gig.event_url}}">{{gig.venue_name}}</a></li>
                </ul>
            {% endfor %}
            </li>
        {% endif %}
    {% endfor %}
    </ul>

    <h1>Upcoming Gigs</h1>
    {% if gig_centre %}
        <script type="text/javascript">
            //<![CDATA[
            var map;
            var markers;
            var icon;

            /**
             * Function: addMarker
             * Add a new marker to the markers layer given the following lonlat, 
             *     popupClass, and popup contents HTML. Also allow specifying 
             *     whether or not to give the popup a close box.
             * 
             * Parameters:
             * ll - {<OpenLayers.LonLat>} Where to place the marker
             * popupClass - {<OpenLayers.Class>} Which class of popup to bring up 
             *     when the marker is clicked.
             * popupContentHTML - {String} What to put in the popup
             * closeBox - {Boolean} Should popup have a close box?
             * overflow - {Boolean} Let the popup overflow scrollbars?
             */
            function add_marker(ll, popupClass, popupContentHTML, closeBox, overflow) {
                var feature = new OpenLayers.Feature(markers, ll); 
                feature.closeBox = closeBox;
                feature.popupClass = popupClass;
                feature.data.popupContentHTML = popupContentHTML;
                feature.data.overflow = (overflow) ? "auto" : "hidden";

                var marker = feature.createMarker();

                var markerClick = function (evt) {
                    if (this.popup == null) {
                        this.popup = this.createPopup(this.closeBox);
                        map.addPopup(this.popup);
                        this.popup.show();
                    } else {
                        this.popup.toggle();
                    }
                    currentPopup = this.popup;
                    OpenLayers.Event.stop(evt);
                };
                marker.events.register("mousedown", feature, markerClick);

                markers.addMarker(marker);
            }

            $(function() {
                OpenLayers.ImgPath = "{% load_js_path 'OpenLayers/img/' %}";
                map = new OpenLayers.Map('map_canvas', {theme: null});

                var bing = new OpenLayers.Layer.VirtualEarth("VE Streets", { layers: "basic", type: VEMapStyle.Shaded });
                map.addLayer(bing);
                map.setCenter(new OpenLayers.LonLat({{ gig_centre.location.long }}, {{gig_centre.location.lat }}), 0);

                markers = new OpenLayers.Layer.Markers("Markers");
                map.addLayer(markers);

                map.addControl(new OpenLayers.Control.LayerSwitcher());

                var size = new OpenLayers.Size(21, 25);
                var offset = new OpenLayers.Pixel(-(size.w/2), -size.h);
                icon = new OpenLayers.Icon("{% load_js_path 'OpenLayers/img/marker.png' %}", size, offset);

                {% for artist in favourite_artists %}
                    {% for gig in artist.gigs %}
                        {% if gig.location %}
                            {% if gig.location.lat and gig.location.long %}
                                var content = '{{artist.name}} - {{gig.date}} at <a href="{{gig.event_url}}">{{gig.venue_name}}</a> </br> <img src="{{artist.image}}" />';
                                add_marker(
                                    new OpenLayers.LonLat({{ gig.location.long }}, {{ gig.location.lat }}, 0),
                                    OpenLayers.Class(OpenLayers.Popup.AnchoredBubble, { 'autoSize': true }),
                                    content,
                                    true
                                );
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            });
            //]]>
        </script>

        <div id="map_canvas" style="width:600px; height:600px"></div>
    {% endif %}
{% else %}
    <h1>No plays this week!</h1>
    <p>Kick back and listen to some tunes.</p>
    {% endif %}
{% endblock %}
