{% extends "base.html" %}
{% load extras %}

{% block head %}
    <script type="text/javascript">
    // <![CDATA[
    var days = {
        {% for day in days %}
            {{ forloop.counter0 }}: []{% if not forloop.last %},{% endif %}
        {% endfor %}
    };
    var item_sort_callback = function(a, b) {
        return a['created'] - b['created'];
    }
    var success = function(data) {
        if (!data['error']) {
            $('li#service_load_' + data['class']).addClass('loaded');
            data = data['items'];
            for (i in data) {
                days[i] = days[i].concat(data[i]);
                day = days[i];
                day_ul = $('ul#day_' + i);
                day_ul.children('li').remove();
                days[i].sort(item_sort_callback);
                days[i].reverse();
                for (j in day) {
                    item = day[j];
                    day_ul.append($('#item_template').jqote(item, '*'));
                }
            }
        } else {
            $('li#service_load_' + data['class']).addClass('service-error');
            $('li#service_load_' + data['class']).append('<span>Sorry! Unable to fetch items from service. :(</span>');
        }
    }
    var load_services = function() {
        {% for service in services %}
            $.get("{% url history-callback viewing_user.username service.pk %}", {}, success, 'json');
        {% endfor %}
    }
    $(function() {
        setTimeout(load_services, 500);
    });
    // ]]>
    </script>
    <link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css"/>
    <link href="/static/css/tabs.css" rel="stylesheet" type="text/css"/>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>
    <script>
        //<![CDATA[
        $(function() {
            $("#service-tabs").tabs().addClass('ui-tabs-vertical ui-helper-clearfix');
            $("#service-tabs li").removeClass('ui-corner-top').addClass('ui-corner-left');
            $('#service-tabs').tabs({
                load: function(event, ui) {
                    $('a', ui.panel).click(function() {
                        $(ui.panel).load(this.href);
                        return false;
                    });
                }
            });
        });
        //]]>
    </script>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
{% endblock %}

{% block primary %}
    <div id="service-tabs">
        <ul>
            <li>
                <a href="#all-services" class="causal-timeline" title="7 day timeline">
                    <span>7 day timeline</span>
                </a>
            </li>
            {% for service in services %}
                {% if service|stats_url %}
                    <li>
                        <a href="{{ service|stats_url }}" class="{{ service.class_name }}" title="{{ service.app.module.DISPLAY_NAME }} stats">
                            <span>{{ service.app.module.DISPLAY_NAME }} stats</span>
                        </a>
                    </li>
                {% endif %}
            {% endfor %}
        </ul>
        <div id="all-services" class="ui-tabs-panel">
            <ul id="loading-services">
                {% for service in services %}
                    <li id="service_load_{{ service.class_name }}">{{ service.app.module.DISPLAY_NAME }}</li>
                {% endfor %}
            </ul>
            {% for items in days %}
                <ul id="day_{{ forloop.counter0 }}">
                    <lh>{{ day_names|get:forloop.counter0 }}</lh>
                </ul>
            {% endfor %}
        </div>
        {% for service in services %}
            <div id="{{ service.class_name }}-stats" class="ui-tabs-panel"></div>
        {% endfor %}
    </div>
    <script type="text/x-jqote-template" id="item_template">
        <![CDATA[
        <li class="<*= this.class_name *>">
            <a href="<*= this.link_back *>">
            <*= this.created_date *></a>:
            <*= this.title ? this.title : '' *>
            <*= (this.title && this.body) ? '&ndash;' : '' *>
            <*= this.body ? this.body : '' *>
        </li>
        ]]>
    </script>
{% endblock primary %}
